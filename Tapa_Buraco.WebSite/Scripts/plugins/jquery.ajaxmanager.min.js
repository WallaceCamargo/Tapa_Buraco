(function(a){"use strict";var c={},b={};a.manageAjax=function(){function e(b,d){c[b]=new a.manageAjax._manager(b,d);return c[b]}function d(a){if(c[a]){c[a].clear(true);delete c[a]}}var b={create:e,destroy:d};return b}();a.manageAjax._manager=function(c,b){this.requests={};this.inProgress=0;this.name=c;this.qName=c;this.opts=a.extend({},a.manageAjax.defaults,b);if(b&&b.queue&&b.queue!==true&&typeof b.queue==="string"&&b.queue!=="clear")this.qName=b.queue};a.manageAjax._manager.prototype={add:function(e,b){if(typeof e=="object")b=e;else if(typeof e=="string")b=a.extend(b||{},{url:e});b=a.extend({},this.opts,b);var h=b.complete||a.noop,i=b.success||a.noop,k=b.beforeSend||a.noop,g=b.error||a.noop,j=typeof b.data=="string"?b.data:a.param(b.data||{}),c=b.type+b.url+j,d=this,f=this._createAjax(c,b,i,h);if(b.preventDoubleRequests&&b.queueDuplicateRequests){if(b.preventDoubleRequests)b.queueDuplicateRequests=false;setTimeout(function(){throw"preventDoubleRequests and queueDuplicateRequests can't be both true";},0)}if(this.requests[c]&&b.preventDoubleRequests)return;f.xhrID=c;b.xhrID=c;b.beforeSend=function(b,e){var a=k.call(this,b,e);a===false&&d._removeXHR(c);b=null;return a};b.complete=function(a,e){d._complete.call(d,this,h,a,e,c,b);a=null};b.success=function(e,c,a){d._success.call(d,this,i,e,c,a,b);a=null};b.error=function(a,c,e){var d="",f="";if(c!=="timeout"&&a){d=a.status;f=a.responseXML||a.responseText}if(g)g.call(this,a,c,e,b);else setTimeout(function(){throw c+"| status: "+d+" | URL: "+b.url+" | data: "+j+" | thrown: "+e+" | response: "+f;},0);a=null};b.queue==="clear"&&a(document).clearQueue(this.qName);if(b.queue||b.queueDuplicateRequests&&this.requests[c]){a.queue(document,this.qName,f);this.inProgress<b.maxRequests&&(!this.requests[c]||!b.queueDuplicateRequests)&&a.dequeue(document,this.qName);return c}return f()},_createAjax:function(c,d,g,f){var e=this;return function(){if(d.beforeCreate.call(d.context||e,c,d)===false)return;e.inProgress++;e.inProgress===1&&a.event.trigger(e.name+"AjaxStart");if(d.cacheResponse&&b[c])if(!b[c].cacheTTL||b[c].cacheTTL<0||+new Date-b[c].timestamp<b[c].cacheTTL){e.requests[c]={};setTimeout(function(){e._success.call(e,d.context||d,g,b[c]._successData,"success",b[c],d);e._complete.call(e,d.context||d,f,b[c],"success",c,d)},0)}else delete b[c];if(!d.cacheResponse||!b[c])if(d.async)e.requests[c]=a.ajax(d);else a.ajax(d);return c}},_removeXHR:function(b){(this.opts.queue||this.opts.queueDuplicateRequests)&&a.dequeue(document,this.qName);this.inProgress--;this.requests[b]=null;delete this.requests[b]},clearCache:function(){b={}},_isAbort:function(a,c,b){if(!b.abortIsNoSuccess||!a&&!c)return false;var d=!!(!a||a.readyState===0||this.lastAbort===b.xhrID);a=null;return d},_complete:function(e,f,d,c,g,b){if(this._isAbort(d,c,b)){c="abort";b.abort.call(e,d,c,b)}f.call(e,d,c,b);a.event.trigger(this.name+"AjaxComplete",[d,c,b]);b.domCompleteTrigger&&a(b.domCompleteTrigger).trigger(this.name+"DOMComplete",[d,c,b]).trigger("DOMComplete",[d,c,b]);this._removeXHR(g);!this.inProgress&&a.event.trigger(this.name+"AjaxStop");d=null},_success:function(j,k,f,h,d,c){var l=this;if(this._isAbort(d,h,c)){d=null;return}c.abortOld&&a.each(this.requests,function(a){if(a===c.xhrID)return false;l.abort(a)});if(c.cacheResponse&&!b[c.xhrID]){if(!d)d={};b[c.xhrID]={status:d.status,statusText:d.statusText,responseText:d.responseText,responseXML:d.responseXML,_successData:f,cacheTTL:c.cacheTTL,timestamp:+new Date};if("getAllResponseHeaders"in d){var g=d.getAllResponseHeaders(),e,i=function(){if(e)return;e={};a.each(g.split("\n"),function(c,a){var b=a.indexOf(":");e[a.substr(0,b)]=a.substr(b+2)})};a.extend(b[c.xhrID],{getAllResponseHeaders:function(){return g},getResponseHeader:function(a){i();return a in e?e[a]:null}})}}k.call(j,f,h,d,c);a.event.trigger(this.name+"AjaxSuccess",[d,c,f]);c.domSuccessTrigger&&a(c.domSuccessTrigger).trigger(this.name+"DOMSuccess",[f,c]).trigger("DOMSuccess",[f,c]);d=null},getData:function(c){if(c){var b=this.requests[c];if(!b&&this.opts.queue)b=a.grep(a(document).queue(this.qName),function(a){return a.xhrID===c})[0];return b}return{requests:this.requests,queue:this.opts.queue?a(document).queue(this.qName):[],inProgress:this.inProgress}},abort:function(c){var b;if(c){b=this.getData(c);if(b&&b.abort){this.lastAbort=c;b.abort();this.lastAbort=false}else a(document).queue(this.qName,a.grep(a(document).queue(this.qName),function(a){return a!==b}));b=null;return}var e=this,d=[];a.each(this.requests,function(a){d.push(a)});a.each(d,function(b,a){e.abort(a)})},clear:function(b){a(document).clearQueue(this.qName);b&&this.abort()}};a.manageAjax._manager.prototype.getXHR=a.manageAjax._manager.prototype.getData;a.manageAjax.defaults={beforeCreate:a.noop,abort:a.noop,abortIsNoSuccess:true,maxRequests:1,cacheResponse:false,async:true,domCompleteTrigger:false,domSuccessTrigger:false,preventDoubleRequests:true,queueDuplicateRequests:false,cacheTTL:-1,queue:false};a.each(a.manageAjax._manager.prototype,function(b,d){if(b.indexOf("_")===0||!a.isFunction(d))return;a.manageAjax[b]=function(d,f){if(!c[d])if(b==="add")a.manageAjax.create(d,f);else return;var e=Array.prototype.slice.call(arguments,1);c[d][b].apply(c[d],e)}})})(jQuery)